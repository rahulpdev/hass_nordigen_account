# Home Assistant Nordigen Integration

This Home Assistant integration provides a way to connect your Nordigen bank account data to Home Assistant, allowing you to monitor your account balances through sensors.

## Features

- Secure connection to Nordigen API using `secret_id` and `secret_key`.
- Automatically fetches balance data for multiple bank accounts.
- Regular updates and notifications for expiring requisition IDs.
- Easy configuration via the Home Assistant UI.
- Supports updating requisition IDs and refresh tokens without reinstallation.
- Improved error handling for invalid credentials, expired requisitions, and API failures.

---

## Installation

### 1. Manual Installation

1. Clone this repository into your Home Assistant `custom_components` directory:

```bash
git clone https://github.com/yourusername/hass-nordigen.git
```

2. Ensure the directory structure looks like this:

```arduino
home-assistant-config/
├── custom_components/
│   ├── nordigen_account/
│   │   ├── __init__.py
│   │   ├── config_flow.py
│   │   ├── const.py
│   │   ├── coordinator.py
│   │   ├── nordigen_wrapper.py
│   │   ├── sensor.py
│   │   ├── manifest.json
```

3. Restart Home Assistant to detect the custom component.

---

## Configuration

1. In Home Assistant, navigate to **Settings > Devices & Services > Add Integration**.
2. Search for **Nordigen Account** and follow the on-screen instructions to enter your API credentials.
3. Required fields:
   - **Secret ID** (from Nordigen API dashboard)
   - **Secret Key** (from Nordigen API dashboard)
   - **Requisition ID** (obtained after linking your bank)
   - **Refresh Token** (optional, auto-generated by Nordigen)

---

## Updating the Integration

If your requisition ID or refresh token needs to be updated (every 90 days for requisition IDs), follow these steps:

1. Navigate to **Settings > Devices & Services > Nordigen Integration**.
2. Click **Configure**, update the required fields, and save.

---

## How It Works

### `__init__.py`

The `async_setup_entry` function is responsible for setting up the integration with the provided user credentials.

#### Key Steps:

1. **Create the data coordinator for periodic updates:**

```python
coordinator = NordigenDataUpdateCoordinator(hass, entry)
await coordinator.async_initialize(hass)  # Ensure async-safe initialization
await coordinator.async_config_entry_first_refresh()

# Coordinator dynamically adjusts update intervals when a 429 rate limit is encountered, preventing unnecessary retries.

# Coordinator also fires an event `nordigen_requisition_expired` when a 428 Expired Requisition error occurs, allowing automations to trigger notifications.
```

2. **Store the coordinator in Home Assistant memory:**

```python
hass.data[DOMAIN][entry.entry_id] = {
    "coordinator": coordinator
}
```

3. **Handle Errors Gracefully:**

```python
except NordigenAPIError as e:
    _LOGGER.error("Nordigen API error: %s", e)
    return False
```

4. **Forward sensor setup:**

```python
await hass.config_entries.async_forward_entry_setups(entry, ["sensor"])
```

---

## Uninstalling

To remove the Nordigen integration from Home Assistant:

1. Navigate to **Settings > Devices & Services**.
2. Find **Nordigen Account**, click **Delete**.
3. Remove the custom component folder if installed manually:

```bash
rm -rf home-assistant-config/custom_components/nordigen_account
```

---

## Logging and Debugging

To enable detailed logging for troubleshooting, add the following to your `configuration.yaml`:

```yaml
logger:
  default: warning
  logs:
    custom_components.nordigen_account: debug
```

---

## Troubleshooting

**Common Issues and Fixes:**

1. **Invalid API Credentials:**
   - Double-check your **Secret ID** and **Secret Key** in the Nordigen dashboard.
2. **Requisition Expired Notification:**
   - Navigate to **Settings > Integrations** and update your requisition ID.
3. **Sensors Not Updating:**
   - Restart Home Assistant and check the logs for any API-related errors.
4. **API Error Handling:**
   - If you see error logs mentioning authentication or API failures, review the status codes and update credentials accordingly.

---

## License

This project is licensed under the MIT License.

---

## Credits

- Built with ❤️ for Home Assistant.
- Powered by the Nordigen API.

---

## Contributions

Feel free to submit pull requests or open issues to improve the integration. Contributions are welcome!

---

## Contact

If you have any questions or suggestions, feel free to contact me via GitHub or Home Assistant forums.

